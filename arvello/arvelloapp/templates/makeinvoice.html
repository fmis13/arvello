{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Novi račun - {{ block.super }}{% endblock %}

{% block css %}
<style>
  .formsetDynamic {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-top: 1rem;
    background-color: #f8f9fa;
  }
  .formsetDynamic:first-of-type {
    margin-top: 0;
  }
  .form-group.required .control-label:after { 
    content: " *";
    color: #dc3545;
  }
</style>
<!-- Select2 CSS for searchable dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
  /* Select2 custom styling to match Bootstrap 5 */
  .select2-container--bootstrap-5 .select2-selection {
    min-height: 38px;
  }
  .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
    line-height: 36px;
  }
</style>
{% endblock %}

{% block main %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Novi račun</h1>
  <a href="{% url 'invoices' %}" class="btn btn-secondary">
    <i class="bi bi-arrow-left me-1"></i>Natrag na popis
  </a>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="h5 mb-0">Podaci o računu</h2>
  </div>
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      {% crispy invoice_form %}
      
      <hr class="my-4">
      <h3 class="h5 mb-3">Stavke računa</h3>
      
      {{ invoice_formset.management_form|crispy }}
      {% for form in invoice_formset %}
        <div class="formsetDynamic">
          {% crispy form %}
        </div>
      {% endfor %}
      
      <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
        <a href="{% url 'invoices' %}" class="btn btn-secondary">
          <i class="bi bi-x-circle me-1"></i>Odustani
        </a>
        <button type="submit" id="submit-button" class="btn btn-primary">
          <i class="bi bi-check-lg me-1"></i>Spremi račun
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Select2 JS for searchable dropdowns -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/hr.js"></script>

<script type="text/javascript">
  // Client type data for auto-detection
  var clientTypes = {
    {% for client in clients %}
    "{{ client.id }}": "{{ client.clientType }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  };

  // Client OIB data for search functionality
  var clientOibs = {
    {% for client in clients %}
    "{{ client.id }}": "{{ client.OIB|default:'' }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  };

  // Auto-detect invoice type based on client selection
  function autoDetectInvoiceType() {
    var clientSelect = document.getElementById('id_client');
    var invoiceTypeSelect = document.getElementById('id_invoice_type');
    
    if (clientSelect && invoiceTypeSelect && clientSelect.value) {
      var clientType = clientTypes[clientSelect.value];
      if (clientType === 'Pravna osoba') {
        // Legal entity -> Wholesale (F2)
        invoiceTypeSelect.value = 'veleprodajni';
      } else {
        // Natural person -> Retail (F1)
        invoiceTypeSelect.value = 'maloprodajni';
      }
    }
  }

  // Add data-oib attributes to select options for search
  function addOibDataAttributes() {
    var $clientSelect = $('#id_client');
    if ($clientSelect.length) {
      $clientSelect.find('option').each(function() {
        var optionValue = $(this).val();
        if (optionValue && clientOibs[optionValue]) {
          $(this).attr('data-oib', clientOibs[optionValue]);
        }
      });
    }
  }

  // Initialize Select2 with search functionality
  function initClientSelect2() {
    var $clientSelect = $('#id_client');
    if ($clientSelect.length) {
      // Add OIB data attributes before initializing Select2
      addOibDataAttributes();
      
      $clientSelect.select2({
        theme: 'bootstrap-5',
        language: 'hr',
        placeholder: 'Odaberite klijenta...',
        allowClear: true,
        width: '100%',
        matcher: function(params, data) {
          // Custom matcher to search by name and OIB
          if ($.trim(params.term) === '') {
            return data;
          }
          
          var searchTerm = params.term.toLowerCase();
          var text = (data.text || '').toLowerCase();
          var oib = (data.element && data.element.dataset && data.element.dataset.oib) || '';
          
          // Search in client name
          if (text.indexOf(searchTerm) > -1) {
            return data;
          }
          
          // Search in OIB
          if (oib && oib.indexOf(searchTerm) > -1) {
            return data;
          }
          
          return null;
        }
      });
      
      // Handle Select2 change event for auto-detection
      $clientSelect.on('select2:select', function(e) {
        autoDetectInvoiceType();
      });
      $clientSelect.on('select2:clear', function(e) {
        // Reset invoice type when client is cleared
        var invoiceTypeSelect = document.getElementById('id_invoice_type');
        if (invoiceTypeSelect) {
          invoiceTypeSelect.value = '';
        }
      });
    }
  }

  // Attach event listener to client select
  $(document).ready(function() {
    // Initialize Select2
    initClientSelect2();
    
    var clientSelect = document.getElementById('id_client');
    if (clientSelect) {
      // Auto-detect on page load if client is already selected
      if (clientSelect.value) {
        autoDetectInvoiceType();
      }
    }
  });

  function updateElementIndex(el, prefix, ndx) {
      var id_regex = new RegExp('(' + prefix + '-\\d+)');
      var replacement = prefix + '-' + ndx;
      if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
      if (el.id) el.id = el.id.replace(id_regex, replacement);
      if (el.name) el.name = el.name.replace(id_regex, replacement);
  }
  
  function cloneMore(selector, prefix) {
      var newElement = $(selector).clone(true);
      var total = $('#id_' + prefix + '-TOTAL_FORMS').val();
      newElement.find(':input:not([type=button]):not([type=submit]):not([type=reset])').each(function () {
          var name = $(this).attr('name')
          if (name) {
              name = name.replace('-' + (total - 1) + '-', '-' + total + '-');
              var id = 'id_' + name;
              $(this).attr({ 'name': name, 'id': id }).val('').removeAttr('checked');
          }
      });
      newElement.find('label').each(function () {
          var forValue = $(this).attr('for');
          if (forValue) {
              forValue = forValue.replace('-' + (total - 1) + '-', '-' + total + '-');
              $(this).attr({ 'for': forValue });
          }
      });
      total++;
      $('#id_' + prefix + '-TOTAL_FORMS').val(total);
      $(selector).after(newElement);
      var buttons = document.querySelectorAll('.buttonDynamic');
      for (var i = 1; i < buttons.length; i++) {
          buttons[i].style.display = 'none';
      }
      return false;
  }
  
  $(document).on('click', '.buttonDynamic', function (e) {
      e.preventDefault();
      cloneMore('.formsetDynamic:last', 'invoiceproduct_set');
      return false;
  });
</script>
{% endblock %}

