{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Nova ponuda - {{ block.super }}{% endblock %}

{% block css %}
<style>
  .formsetDynamic {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-top: 1rem;
    background-color: #f8f9fa;
  }
  .formsetDynamic:first-of-type {
    margin-top: 0;
  }
  .form-group.required .control-label:after { 
    content: " *";
    color: #dc3545;
  }
</style>
{% endblock %}

{% block main %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Nova ponuda</h1>
  <a href="{% url 'offers' %}" class="btn btn-secondary">
    <i class="bi bi-arrow-left me-1"></i>Natrag na popis
  </a>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="h5 mb-0">Podaci o ponudi</h2>
  </div>
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      {% crispy offer_form %}
      
      <hr class="my-4">
      <h3 class="h5 mb-3">Stavke ponude</h3>
      
      {{ offer_formset.management_form|crispy }}
      {% for form in offer_formset %}
        <div class="formsetDynamic">
          {% crispy form %}
        </div>
      {% endfor %}
      
      <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
        <a href="{% url 'offers' %}" class="btn btn-secondary">
          <i class="bi bi-x-circle me-1"></i>Odustani
        </a>
        <button type="submit" id="submit-button" class="btn btn-primary">
          <i class="bi bi-check-lg me-1"></i>Spremi ponudu
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script type="text/javascript">
  function updateElementIndex(el, prefix, ndx) {
      var id_regex = new RegExp('(' + prefix + '-\\d+)');
      var replacement = prefix + '-' + ndx;
      if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
      if (el.id) el.id = el.id.replace(id_regex, replacement);
      if (el.name) el.name = el.name.replace(id_regex, replacement);
  }
  
  function cloneMore(selector, prefix) {
      var newElement = $(selector).clone(true);
      var total = $('#id_' + prefix + '-TOTAL_FORMS').val();
      newElement.find(':input:not([type=button]):not([type=submit]):not([type=reset])').each(function () {
          var name = $(this).attr('name')
          if (name) {
              name = name.replace('-' + (total - 1) + '-', '-' + total + '-');
              var id = 'id_' + name;
              $(this).attr({ 'name': name, 'id': id }).val('').removeAttr('checked');
          }
      });
      newElement.find('label').each(function () {
          var forValue = $(this).attr('for');
          if (forValue) {
              forValue = forValue.replace('-' + (total - 1) + '-', '-' + total + '-');
              $(this).attr({ 'for': forValue });
          }
      });
      total++;
      $('#id_' + prefix + '-TOTAL_FORMS').val(total);
      $(selector).after(newElement);
      var buttons = document.querySelectorAll('.buttonDynamic');
      for (var i = 1; i < buttons.length; i++) {
          buttons[i].style.display = 'none';
      }
      return false;
  }
  
  $(document).on('click', '.buttonDynamic', function (e) {
      e.preventDefault();
      cloneMore('.formsetDynamic:last', 'offerproduct_set');
      return false;
  });
</script>
{% endblock %}

