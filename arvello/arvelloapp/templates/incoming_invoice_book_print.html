{% extends 'base.html' %}
{% load static %}
{% load user_extras %}
{% block main %}

<title>Knjiga ulaznih računa</title>
<link rel="stylesheet" href="{% static 'css/invoice_book_print.css' %}">
<style>
    /* ==== PAGE SETUP ==== */
    @page {
        size: A4 landscape;
        margin: 0.8cm;
    }

    /* ==== PRINT STYLES ==== */
    @media print {
        /* Hide screen-only elements */
        .no-print,
        .navbar,
        header.navbar,
        .sticky-top,
        .sidebar,
        .alert,
        form {
            display: none !important;
        }
        
        /* Show print footer */
        .print-footer {
            display: flex !important;
        }
        
        /* Layout reset */
        body {
            font-size: 9pt !important;
            margin: 0;
            padding: 0;
            padding-bottom: 2cm; /* Space for fixed footer */
        }
        
        .main-content,
        .content-area {
            margin-left: 0 !important;
            padding-left: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }
        
        .main-container,
        main {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        .container-fluid {
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
        }
        
        .table-container {
            overflow: visible !important;
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            margin-bottom: 1.5cm !important; /* Space for footer */
        }
        
        /* Table base styles */
        .table {
            width: 100% !important;
            table-layout: fixed !important;
            border-collapse: collapse !important;
            font-size: 8pt !important;
            margin: 0 !important;
        }
        
        .table td, .table th {
            padding: 2px 3px !important;
            vertical-align: middle !important;
            border: 1px solid #000 !important;
        }
        
        /* Table pagination - headers repeat on each page */
        thead {
            display: table-header-group !important;
        }
        
        thead tr {
            page-break-after: avoid;
        }
        
        tfoot {
            display: table-footer-group !important;
        }
        
        /* Prevent row breaking */
        tr {
            page-break-inside: avoid;
        }
        
        /* Table allows natural page breaks */
        table {
            page-break-inside: auto;
        }
        
        /* Invoice table specific */
        .invoice-table {
            font-size: 7pt !important;
        }
        
        .invoice-table th,
        .invoice-table td {
            padding: 1px 2px !important;
            font-size: 7pt !important;
        }
        
        /* Column widths */
        .invoice-table th.multiline,
        .invoice-table td:first-child {
            width: 3% !important;
            text-align: center !important;
        }
        
        .invoice-table td:nth-child(2),
        .invoice-table td:nth-child(3) {
            width: 5% !important;
        }
        
        .supplier-name-heading,
        .invoice-table td:nth-child(4) {
            width: 12% !important;
            white-space: normal !important;
            word-break: break-word !important;
            text-align: left !important;
            line-height: 1.2 !important;
        }
        
        .invoice-table td:nth-child(5) {
            width: 6% !important;
        }
        
        /* Numeric columns */
        .numeric,
        .table td.numeric,
        .invoice-table td.numeric {
            text-align: right !important;
            padding-right: 3px !important;
            white-space: nowrap !important;
            font-family: monospace !important;
        }
        
        .text-end {
            text-align: right !important;
        }
        
        tfoot td.text-end {
            text-align: right !important;
            padding-right: 10px !important;
        }
        
        /* Print footer - fixed at bottom of each page */
        .print-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1.5cm;
            padding: 0.3cm 1cm;
            font-size: 7pt;
            border-top: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: white;
        }
    }

    /* ==== SCREEN STYLES ==== */
    @media screen {
        .print-footer {
            display: none;
        }
        
        .content-wrapper {
            margin-left: 0;
        }
    }
    
    .table-container {
        overflow-x: auto;
        width: 100%;
        display: flex;
        justify-content: center;
    }
    
    .small-text {
        font-size: 0.9em;
    }
    
    .footer-info {
        margin-top: 20px;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
    }

    .footer-left {
        text-align: left;
        flex: 0 0 auto;
    }

    .footer-right {
        text-align: right;
        flex: 0 0 auto;
    }

    .content-wrapper {
        width: 100%;
        padding: 20px;
    }

    .text-center {
        text-align: center;
    }

    .italic-small {
        font-style: italic;
        font-size: 0.8em;
    }
</style>

<div class="invoice-book-content">
    <div class="container-fluid mb-4 no-print">
        <div class="row">
            <div class="col-12">
                <h2 class="my-4">Knjiga primljenih (ulaznih) računa</h2>
                {% if info_text %}
                <div class="alert alert-info" role="alert">
                    {{ info_text }}
                </div>
                {% endif %}
                <form method="post" class="card p-3">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-4">
                            {{ form.company.label_tag }}
                            {{ form.company }}
                        </div>
                        <div class="col-md-8">
                            <div class="form-group">
                                {{ form.filter_type.label_tag }}
                                {% for radio in form.filter_type %}
                                    <div class="form-check">
                                        {{ radio.tag }}
                                        <label class="form-check-label" for="{{ radio.id_for_label }}">
                                            {{ radio.choice_label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3" id="month-year-filters">
                        <div class="col-md-3">
                            {{ form.year.label_tag }}
                            {{ form.year }}
                        </div>
                        <div class="col-md-3">
                            {{ form.month.label_tag }}
                            {{ form.month }}
                        </div>
                    </div>
                    <div class="row mt-3" id="date-range-filters" style="display: none;">
                        <div class="col-md-3">
                            {{ form.date_from.label_tag }}
                            {{ form.date_from }}
                        </div>
                        <div class="col-md-3">
                            {{ form.date_to.label_tag }}
                            {{ form.date_to }}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">Prikaži</button>
                            <button type="button" class="btn btn-secondary" onclick="window.print()">Ispiši</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% if show_results %}
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h3>{{ company.clientName }}</h3>
                <p>{{ company.addressLine1 }}, {{ company.postalCode }} {{ company.town }}<br>
                    OIB: {{ company.OIB }}</p>
                <h4>Knjiga primljenih (ulaznih) računa - Obrazac U-RA</h4>
                <p>Razdoblje: {{ start_date|date:"d.m.Y." }} - {{ end_date|date:"d.m.Y." }}</p>
            </div>
        </div>
        <div class="table-container">
            <table class="table table-bordered table-sm invoice-table">
                <thead>
                    <tr>
                        <th rowspan="3" class="multiline">RED.<br>BR.</th>
                        <th colspan="2">RAČUN</th>
                        <th colspan="8">DOBAVLJAČ (ISPORUČITELJ DOBARA ILI USLUGA)</th>
                        <th colspan="6">PRETPOREZ</th>
                    </tr>
                    <tr>
                        <th rowspan="2" class="small-heading">BROJ</th>
                        <th rowspan="2" class="small-heading">DATUM</th>
                        <th rowspan="2" class="small-heading supplier-name-heading">NAZIV - IME<br>I PREZIME<br>I SJEDIŠTE/<br>PREBIVALIŠTE<br>ILI UOBIČAJENO<br>BORAVIŠTE</th>
                        <th rowspan="2" class="small-heading">(PDV ID.<br>BR./<br>OIB)</th>
                        <th colspan="6">POREZNA OSNOVICA</th>
                        <th colspan="2">5%</th>
                        <th colspan="2">13%</th>
                        <th colspan="2">25%</th>
                    </tr>
                    <tr>
                        <th class="small-heading">0%</th>
                        <th class="small-heading">5%</</th>
                        <th class="small-heading">13%</</th>
                        <th class="small-heading">25%</</th>
                        <th class="small-heading">UKUPNI<br>IZNOS<br>RAČUNA<br>S PDV-om</th>
                        <th class="small-heading">UKUPNO</th>
                        <th class="small-heading">MOŽE SE<br>ODBITI</th>
                        <th class="small-heading">NE MOŽE<br>SE ODBITI</th>
                        <th class="small-heading">MOŽE SE<br>ODBITI</th>
                        <th class="small-heading">NE MOŽE<br>SE ODBITI</th>
                        <th class="small-heading">MOŽE SE<br>ODBITI</th>
                        <th class="small-heading">NE MOŽE<br>SE ODBITI</th>
                    </tr>
                    <tr class="text-center italic-small">
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                        <th>6</th>
                        <th>7</th>
                        <th>8</th>
                        <th>9</th>
                        <th>10</th>
                        <th>11</th>
                        <th>12</th>
                        <th>13</th>
                        <th>14</th>
                        <th>15</th>
                        <th>16</th>
                        <th>17</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                    <tr>
                        <td class="text-center">{{ forloop.counter }}</td>
                        <td>{{ expense.invoice_number|default:"-" }}</td>
                        <td>{{ expense.date|date:"d.m.Y."|default:"-" }}</td>
                        <td>{% if expense.supplier %}{{ expense.supplier.supplierName }}{% else %}{{ expense.title }}{% endif %}</td>
                        <td>{% if expense.supplier %}{{ expense.supplier.OIB|default:"-" }}{% else %}-{% endif %}</td>
                        <td class="numeric">{{ expense.tax_base_0|floatformat:2 }}</td>
                        <td class="numeric">{{ expense.tax_base_5|floatformat:2 }}</td>
                        <td class="numeric">{{ expense.tax_base_13|floatformat:2 }}</td>
                        <td class="numeric">{{ expense.tax_base_25|floatformat:2 }}</td>
                        <td class="numeric">{{ expense.total_amount|floatformat:2 }}</td>
                        <td class="numeric">{{ expense.total_tax|floatformat:2 }}</td>
                        <td class="numeric">{{ expense.tax_5_deductible|floatformat:2 }}</td>
                        <td class="numeric">{{ expense.tax_5_nondeductible|floatformat:2 }}</td>
                        <td class="numeric">{{ expense.tax_13_deductible|floatformat:2 }}</td>
                        <td class="numeric">{{ expense.tax_13_nondeductible|floatformat:2 }}</td>
                        <td class="numeric">{{ expense.tax_25_deductible|floatformat:2 }}</td>
                        <td class="numeric">{{ expense.tax_25_nondeductible|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="17" class="text-center">Nema pronađenih troškova za odabrano razdoblje</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="font-weight-bold">
                        <td colspan="5" class="text-end" style="text-align: right !important;">UKUPNO:</td>
                        <td class="numeric">{{ total_tax_base_0|floatformat:2 }}</td>
                        <td class="numeric">{{ total_tax_base_5|floatformat:2 }}</td>
                        <td class="numeric">{{ total_tax_base_13|floatformat:2 }}</td>
                        <td class="numeric">{{ total_tax_base_25|floatformat:2 }}</td>
                        <td class="numeric">{{ total_with_tax|floatformat:2 }}</td>
                        <td class="numeric">{{ total_tax|floatformat:2 }}</td>
                        <td class="numeric">{{ total_tax_5_deductible|floatformat:2 }}</td>
                        <td class="numeric">{{ total_tax_5_nondeductible|floatformat:2 }}</td>
                        <td class="numeric">{{ total_tax_13_deductible|floatformat:2 }}</td>
                        <td class="numeric">{{ total_tax_13_nondeductible|floatformat:2 }}</td>
                        <td class="numeric">{{ total_tax_25_deductible|floatformat:2 }}</td>
                        <td class="numeric">{{ total_tax_25_nondeductible|floatformat:2 }}</td>
                    </tr>
                    <tr class="font-weight-bold">
                        <td colspan="10" class="text-end" style="text-align: right !important;">UKUPNO ODBITNI PRETPOREZ:</td>
                        <td class="numeric">{{ total_tax_deductible|floatformat:2 }}</td>
                        <td colspan="6"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <!-- Screen-only footer with print button hint -->
        <div class="footer-info no-print">
            <div class="footer-left">
                <span class="small-text">
                    Korisnik: {{ request.user|full_name_with_title }}<br>
                    Generirano: {{ generated_at|date:"d.m.Y. H:i:s" }}<br>
                    Napravljeno sukladno čl. 165 Pravilnika o porezu na dodatnu vrijednost ("Narodne novine" br. 79/13., 85/13., 160/13., 35/14., 157/14.,<br>
                    130/15., 115/16., 1/17., 41/17., 128/17., 106/18., 1/19., 1/20., 138/20., 1/21., 73/21., 41/22., 133/22., 43/23., 1/24., 39/24., 16/25.)
                </span>
            </div>
            <div class="footer-right">
                <span class="small-text">Pritisnite "Ispiši" za ispis</span>
            </div>
        </div>
        
        <!-- Print footer - visible on every printed page -->
        <div class="print-footer">
            <div class="footer-left">
                <span class="small-text">
                    Korisnik: {{ request.user|full_name_with_title }} | Generirano: {{ generated_at|date:"d.m.Y. H:i:s" }}<br>
                    Čl. 165 Pravilnika o PDV-u (NN 79/13., 85/13., 160/13., 35/14., 157/14., 130/15., 115/16., 1/17., 41/17., 128/17., 106/18., 1/19., 1/20., 138/20., 1/21., 73/21., 41/22., 133/22., 43/23., 1/24., 39/24., 16/25.)
                </span>
            </div>
            <div class="footer-right">
                <span class="small-text">{{ company.clientName }}</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="{% static 'js/bootstrap.min.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterType = document.querySelector('[name="filter_type"]');
        const monthYearFilters = document.getElementById('month-year-filters');
        const dateRangeFilters = document.getElementById('date-range-filters');

        function updateFilters() {
            const selected = document.querySelector('[name="filter_type"]:checked').value;
            if (selected === 'month_year') {
                monthYearFilters.style.display = 'flex';
                dateRangeFilters.style.display = 'none';
            } else {
                monthYearFilters.style.display = 'none';
                dateRangeFilters.style.display = 'flex';
            }
        }

        document.querySelectorAll('[name="filter_type"]').forEach(radio => {
            radio.addEventListener('change', updateFilters);
        });

        updateFilters();
    });
</script>
{% endblock %}
