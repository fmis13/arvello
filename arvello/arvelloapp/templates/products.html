{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load history_extras %}

{% block main %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Usluge i proizvodi</h1>
    <div class="d-flex gap-2">
      <a href="{% get_history_url 'Product' %}" class="btn btn-secondary">
        <i class="bi bi-clock-history me-1"></i>Povijest promjena
      </a>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="bi bi-plus-circle me-1"></i>Nova usluga/proizvod
      </button>
    </div>
  </div>

  <!-- <canvas class="my-4 w-100" id="myChart" width="900" height="380"></canvas> -->

  <!-- Search form -->
  <form method="get" class="mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-6">
        <div class="input-group">
          <input type="text" name="q" class="form-control" placeholder="Pretraži po nazivu, ID-u ili opisu..." value="{{ q }}">
          <button type="submit" class="btn btn-outline-primary">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>
      <div class="col-md-2">
        {% if q %}
        <a href="{% url 'products' %}" class="btn btn-outline-secondary">Očisti</a>
        {% endif %}
      </div>
    </div>
  </form>
  <div class="card">
    <div class="card-header">
      <h5 class="card-title mb-0">Popis usluga i proizvoda</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" role="table" aria-label="Tablica usluga i proizvoda">
      <thead>
        <tr>
          <th scope="col">Naslov</th>
          <th scope="col">Interni opis</th>
          <th scope="col">ID</th>
          <th scope="col">KPD</th>
          <th scope="col">Iznos</th>
          <th scope="col">Akcije</th>
        </tr>
      </thead>
      <tbody>

        {% for product in product %}
      <tr>
        <td>{{product.title}}</td>
        <td>{{product.description}}</td>
        <td>{{product.barid}}</td>
        <td>{% if product.kpd_code %}<span title="{{ product.kpd_code.name }}">{{ product.kpd_code.code }}</span>{% else %}-{% endif %}</td>
        <td>{{product.price}} {{product.currency}}</td>
        <td>
          <a href="{% url 'product_label' product.id %}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary btn-sm" aria-label="Preuzmi">
            <i class="bi bi-download"></i>
          </a>
        </td>
      </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-secondary py-4">Nema usluga ili proizvoda za prikaz.</td>
        </tr>
        {% endfor %}

        </tbody>
      </table>
    </div>
  </div>
</div>
  <!-- Pagination controls -->
  {% if product.has_other_pages %}
  <nav class="mt-3">
    <ul class="pagination justify-content-center">
      {% if product.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ product.previous_page_number }}{% if q %}&q={{ q }}{% endif %}">Prethodna</a>
      </li>
      {% endif %}
      <li class="page-item active">
        <span class="page-link">{{ product.number }} / {{ product.paginator.num_pages }}</span>
      </li>
      {% if product.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ product.next_page_number }}{% if q %}&q={{ q }}{% endif %}">Sljedeća</a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
  <div class="mt-3 text-muted small">
    <a href="{% url 'admin:arvelloapp_product_changelist' %}" class="text-decoration-none">Jedino administrator može brisati usluge i proizvode, klikom ovdje.</a>
  </div>

  <div class="modal modal-sheet py-5" tabindex="-1" id="addProductModal">
    <div class="modal-dialog">
      <div class="modal-content rounded-6 shadow">
  
        <form class="" action="#" method="post" enctype="multipart/form-data">
          {% csrf_token %}
  
  
        <div class="modal-header border-bottom-0">
          <h5 class="modal-title"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zatvori"></button>
        </div>
  
        <div class="modal-body py-0">
  
          <!-- Manual form rendering to include KPD picker -->
          <p>
            <label for="id_title">Naziv proizvoda:</label>
            {{ form.title }}
          </p>
          <p>
            <label for="id_description">Opis proizvoda:</label>
            {{ form.description }}
          </p>
          <p>
            <label for="id_price">Cijena:</label>
            {{ form.price }}
          </p>
          <p>
            <label for="id_taxPercent">Porez (%):</label>
            {{ form.taxPercent }}
          </p>
          <p>
            <label for="id_currency">Valuta:</label>
            {{ form.currency }}
          </p>
          <p>
            <label for="id_barid">ID (za barkod):</label>
            {{ form.barid }}
          </p>
          
          <!-- KPD Picker Component -->
          <div class="mb-3">
            <label class="form-label">KPD šifra (Klasifikacija proizvoda po djelatnostima)</label>
            <div class="kpd-picker">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" 
                       id="kpd-search-input" 
                       class="form-control" 
                       placeholder="Pretraži po šifri ili nazivu..." 
                       autocomplete="off">
                <button type="button" class="btn btn-outline-secondary" id="kpd-clear-btn" style="display: none;">
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
              {{ form.kpd_code }}
              <div class="kpd-results dropdown-menu w-100" id="kpd-results"></div>
              <div class="kpd-selected mt-2" id="kpd-selected" style="display: none;">
                <div class="alert alert-success py-2 mb-0 d-flex justify-content-between align-items-center">
                  <div>
                    <small class="text-muted d-block" id="kpd-selected-path"></small>
                    <strong id="kpd-selected-display"></strong>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-danger" id="kpd-remove-btn">
                    <i class="bi bi-x"></i>
                  </button>
                </div>
              </div>
              <div class="kpd-loading mt-2" id="kpd-loading" style="display: none;">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">Učitavanje...</span>
                </div>
                <span class="ms-2 text-muted">Pretraživanje...</span>
              </div>
              <small class="form-text text-muted">Unesite najmanje 2 znaka za pretraživanje. Sadrži 5828 šifri.</small>
            </div>
          </div>
  
  
        </div>
        <div class="modal-footer flex-column border-top-0">
          <button type="submit" class="btn btn-lg btn-primary w-100 mx-0 mb-2"><i class="bi bi-check-lg me-1"></i>Spremi izmjene</button>
          <button type="button" class="btn btn-lg btn-light w-100 mx-0" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Zatvori</button>
        </div>
  
        </form>
      </div>
    </div>
  </div>

  <!-- KPD Picker JavaScript -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('kpd-search-input');
    const resultsContainer = document.getElementById('kpd-results');
    const selectedContainer = document.getElementById('kpd-selected');
    const selectedPath = document.getElementById('kpd-selected-path');
    const selectedDisplay = document.getElementById('kpd-selected-display');
    const loadingIndicator = document.getElementById('kpd-loading');
    const clearBtn = document.getElementById('kpd-clear-btn');
    const removeBtn = document.getElementById('kpd-remove-btn');
    const hiddenInput = document.getElementById('id_kpd_code');
    
    let debounceTimer = null;
    let currentResults = [];
    
    // Check if there's an initial value
    if (hiddenInput && hiddenInput.value) {
      // Fetch the initial KPD code details
      fetch(`{% url 'search_kpd_codes' %}?q=${encodeURIComponent(hiddenInput.value)}&limit=1`)
        .then(response => response.json())
        .then(data => {
          if (data.results && data.results.length > 0) {
            const code = data.results[0];
            if (code.code === hiddenInput.value) {
              showSelected(code);
            }
          }
        });
    }
    
    // Debounced search function
    function search(query) {
      if (query.length < 2) {
        hideResults();
        return;
      }
      
      showLoading();
      
      fetch(`{% url 'search_kpd_codes' %}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          hideLoading();
          currentResults = data.results || [];
          displayResults(currentResults);
        })
        .catch(error => {
          hideLoading();
          console.error('KPD search error:', error);
          displayError('Greška pri pretraživanju. Pokušajte ponovo.');
        });
    }
    
    // Display search results
    function displayResults(results) {
      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="dropdown-item text-muted">Nema rezultata</div>';
        resultsContainer.classList.add('show');
        return;
      }
      
      let html = '';
      results.forEach((item, index) => {
        const pathHtml = item.path ? `<small class="text-muted d-block">${escapeHtml(item.path)}</small>` : '';
        html += `
          <a href="#" class="dropdown-item kpd-result-item py-2" data-index="${index}">
            ${pathHtml}
            <span class="fw-bold">${escapeHtml(item.code)}</span> - ${escapeHtml(item.name)}
          </a>
        `;
      });
      
      resultsContainer.innerHTML = html;
      resultsContainer.classList.add('show');
      
      // Add click handlers
      resultsContainer.querySelectorAll('.kpd-result-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const index = parseInt(this.dataset.index);
          selectCode(currentResults[index]);
        });
      });
    }
    
    // Select a KPD code
    function selectCode(code) {
      hiddenInput.value = code.code;
      showSelected(code);
      hideResults();
      searchInput.value = '';
    }
    
    // Show selected code
    function showSelected(code) {
      selectedPath.textContent = code.path || '';
      selectedDisplay.textContent = code.display || `${code.code} - ${code.name}`;
      selectedContainer.style.display = 'block';
      clearBtn.style.display = 'block';
    }
    
    // Clear selection
    function clearSelection() {
      hiddenInput.value = '';
      selectedContainer.style.display = 'none';
      clearBtn.style.display = 'none';
      searchInput.value = '';
      searchInput.focus();
    }
    
    // Hide results dropdown
    function hideResults() {
      resultsContainer.classList.remove('show');
      resultsContainer.innerHTML = '';
    }
    
    // Show/hide loading
    function showLoading() {
      loadingIndicator.style.display = 'block';
    }
    
    function hideLoading() {
      loadingIndicator.style.display = 'none';
    }
    
    // Display error message
    function displayError(message) {
      resultsContainer.innerHTML = `<div class="dropdown-item text-danger">${escapeHtml(message)}</div>`;
      resultsContainer.classList.add('show');
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Event listeners
    searchInput.addEventListener('input', function() {
      const query = this.value.trim();
      
      // Clear existing timer
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }
      
      // Debounce: wait 300ms after user stops typing
      debounceTimer = setTimeout(() => {
        search(query);
      }, 300);
    });
    
    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.kpd-picker')) {
        hideResults();
      }
    });
    
    // Clear button
    clearBtn.addEventListener('click', clearSelection);
    removeBtn.addEventListener('click', clearSelection);
    
    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideResults();
      }
    });
  });
  </script>
  
  <style>
  .kpd-picker {
    position: relative;
  }
  .kpd-picker .kpd-results {
    max-height: 300px;
    overflow-y: auto;
    position: absolute;
    z-index: 1050;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }
  .kpd-picker .kpd-result-item:hover {
    background-color: #f8f9fa;
  }
  .kpd-picker .kpd-result-item small {
    font-size: 0.75rem;
  }
  </style>

{% endblock %}
