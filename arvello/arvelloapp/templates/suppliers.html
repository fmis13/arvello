{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load history_extras %}
{% block main %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Dobavljači</h1>
        <div class="d-flex gap-2">
            <a href="{% get_history_url 'Supplier' %}" class="btn btn-secondary">
                <i class="bi bi-clock-history me-1"></i>Povijest promjena
            </a>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSupplierModal">
                <i class="bi bi-plus-circle me-1"></i>Dodaj dobavljača
            </button>
        </div>
    </div>

    <!-- Search form -->
    <form method="get" class="mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-md-6">
          <div class="input-group">
            <input type="text" name="q" class="form-control" placeholder="Pretraži po nazivu, OIB-u, emailu, gradu..." value="{{ q }}">
            <button type="submit" class="btn btn-outline-primary">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>
        <div class="col-md-2">
          {% if q %}
          <a href="{% url 'suppliers' %}" class="btn btn-outline-secondary">Očisti</a>
          {% endif %}
        </div>
      </div>
    </form>

    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">Popis dobavljača</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" role="table" aria-label="Tablica dobavljača">
            <thead>
                <tr>
                    <th>Naziv</th>
                    <th>OIB</th>
                    <th>Adresa</th>
                    <th>Grad</th>
                    <th>Tel. br.</th>
                    <th>Email</th>
                    <th>Radnje</th>
                </tr>
            </thead>
            <tbody>
                {% for supplier in suppliers %}
                <tr>
                    <td>{{ supplier.supplierName }}</td>
                    <td>{{ supplier.OIB|default:"-" }}</td>
                    <td>{{ supplier.addressLine1 }}</td>
                    <td>{{ supplier.town }}</td>
                    <td>{{ supplier.phoneNumber|default:"-" }}</td>
                    <td>{{ supplier.emailAddress|default:"-" }}</td>
                    <td class="text-end">
                        <button type="button" class="btn btn-outline-primary btn-sm me-1 view-supplier"
                               data-id="{{ supplier.id }}"
                               data-naziv="{{ supplier.supplierName }}"
                               data-adresa="{{ supplier.addressLine1 }}"
                               data-grad="{{ supplier.town }}"
                               data-postanski-broj="{{ supplier.postalCode }}"
                               data-zupanija="{{ supplier.province }}"
                               data-telefon="{{ supplier.phoneNumber|default:'' }}"
                               data-email="{{ supplier.emailAddress|default:'' }}"
                               data-vrsta-subjekta="{{ supplier.businessType }}"
                               data-oib="{{ supplier.OIB|default:'' }}"
                               data-iban="{{ supplier.IBAN|default:'' }}"
                               data-napomena="{{ supplier.notes|default:'' }}"
                               data-bs-toggle="modal" 
                               data-bs-target="#viewSupplierModal"
                               aria-label="Pregledaj">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm me-1 edit-supplier"
                               data-id="{{ supplier.id }}"
                               data-naziv="{{ supplier.supplierName }}"
                               data-adresa="{{ supplier.addressLine1 }}"
                               data-grad="{{ supplier.town }}"
                               data-postanski-broj="{{ supplier.postalCode }}"
                               data-zupanija="{{ supplier.province }}"
                               data-telefon="{{ supplier.phoneNumber|default:'' }}"
                               data-email="{{ supplier.emailAddress|default:'' }}"
                               data-vrsta-subjekta="{{ supplier.businessType }}"
                               data-oib="{{ supplier.OIB|default:'' }}"
                               data-iban="{{ supplier.IBAN|default:'' }}"
                               data-napomena="{{ supplier.notes|default:'' }}"
                               data-bs-toggle="modal" 
                               data-bs-target="#editSupplierModal"
                               aria-label="Uredi">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm delete-supplier"
                               data-id="{{ supplier.id }}"
                               data-naziv="{{ supplier.supplierName }}"
                               data-bs-toggle="modal" 
                               data-bs-target="#deleteSupplierModal"
                               aria-label="Obriši">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center text-secondary py-4">Nadodajte prvog dobavljača</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
      </div>
    </div>
    </div>
    <!-- Pagination controls -->
    {% if suppliers.has_other_pages %}
    <nav class="mt-3">
      <ul class="pagination justify-content-center">
        {% if suppliers.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ suppliers.previous_page_number }}{% if q %}&q={{ q }}{% endif %}">Prethodna</a>
        </li>
        {% endif %}
        <li class="page-item active">
          <span class="page-link">{{ suppliers.number }} / {{ suppliers.paginator.num_pages }}</span>
        </li>
        {% if suppliers.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ suppliers.next_page_number }}{% if q %}&q={{ q }}{% endif %}">Sljedeća</a>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}

    <div class="modal modal-sheet py-5" tabindex="-1" id="addSupplierModal">
        <div class="modal-dialog">
            <div class="modal-content rounded-6 shadow">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title">Novi dobavljač</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zatvori"></button>
                </div>
                <form method="post" id="addSupplierForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add">
                    
                    <div class="modal-body py-0">
                        <!-- Court Registry Lookup Section -->
                        <div class="card bg-light mb-3">
                          <div class="card-body py-3">
                            <h6 class="card-title mb-2">
                              <i class="bi bi-search me-1"></i>Dohvati podatke iz Sudskog registra
                            </h6>
                            <div class="row g-2">
                              <div class="col-8">
                                <input type="text" id="lookupOibSupplier" class="form-control form-control-sm" 
                                       placeholder="Unesite OIB (11 znamenki)" maxlength="11" pattern="\d{11}">
                              </div>
                              <div class="col-4">
                                <button type="button" class="btn btn-outline-primary btn-sm w-100" 
                                        id="fetchSupplierFromRegistryBtn" onclick="fetchSupplierFromRegistry()">
                                  <i class="bi bi-download me-1"></i>Dohvati
                                </button>
                              </div>
                            </div>
                            <div id="registryStatusSupplier" class="mt-2 small"></div>
                          </div>
                        </div>
                        
                        {{ form|crispy }}
                    </div>
                    
                    <div class="modal-footer flex-column border-top-0">
                        <button type="submit" class="btn btn-lg btn-primary w-100 mx-0 mb-2"><i class="bi bi-check-lg me-1"></i>Spremi</button>
                        <button type="button" class="btn btn-lg btn-light w-100 mx-0" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Odustani</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal modal-sheet py-5" tabindex="-1" id="viewSupplierModal">
        <div class="modal-dialog">
            <div class="modal-content rounded-6 shadow">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title">Detalji dobavljača: <span id="viewSupplierTitle"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zatvori"></button>
                </div>
                <div class="modal-body py-0">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Naziv dobavljača:</strong>
                            <p id="viewSupplierNaziv"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Vrsta subjekta:</strong>
                            <p id="viewSupplierVrsta"></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>OIB:</strong>
                            <p id="viewSupplierOIB"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>IBAN:</strong>
                            <p id="viewSupplierIBAN"></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Adresa:</strong>
                            <p id="viewSupplierAdresa"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Grad:</strong>
                            <p id="viewSupplierGrad"></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Županija:</strong>
                            <p id="viewSupplierZupanija"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Poštanski broj:</strong>
                            <p id="viewSupplierPostanski"></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Telefon:</strong>
                            <p id="viewSupplierTelefon"></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>E-mail:</strong>
                            <p id="viewSupplierEmail"></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 mb-3">
                            <strong>Napomena:</strong>
                            <p id="viewSupplierNapomena"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer flex-column border-top-0">
                    <button type="button" class="btn btn-lg btn-secondary w-100 mx-0" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Zatvori</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal modal-sheet py-5" tabindex="-1" id="editSupplierModal">
        <div class="modal-dialog">
            <div class="modal-content rounded-6 shadow">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title">Uredi dobavljača: <span id="editSupplierTitle"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zatvori"></button>
                </div>
                <form method="post" id="edit-supplier-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="supplier_id" id="edit_supplier_id">
                    
                    <div class="modal-body py-0">
                        {{ edit_form|crispy }}
                    </div>
                    
                    <div class="modal-footer flex-column border-top-0">
                        <button type="submit" class="btn btn-lg btn-primary w-100 mx-0 mb-2"><i class="bi bi-check-lg me-1"></i>Spremi promjene</button>
                        <button type="button" class="btn btn-lg btn-light w-100 mx-0" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Odustani</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteSupplierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Potvrda brisanja</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zatvori"></button>
                </div>
                <div class="modal-body">
                    <p>Jeste li sigurni da želite izbrisati dobavljača: <span id="deleteSupplierName"></span>?</p>
                </div>
                <div class="modal-footer">
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="supplier_id" id="delete_supplier_id">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Odustani</button>
                        <button type="submit" class="btn btn-danger"><i class="bi bi-trash me-1"></i>Izbriši</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
// Fetch supplier data from Court Registry
function fetchSupplierFromRegistry() {
    const oibInput = document.getElementById('lookupOibSupplier');
    const statusDiv = document.getElementById('registryStatusSupplier');
    const fetchBtn = document.getElementById('fetchSupplierFromRegistryBtn');
    const oib = oibInput.value.trim();
    
    // Validate OIB
    if (!oib) {
        statusDiv.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Molimo unesite OIB.</span>';
        return;
    }
    
    if (!/^\d{11}$/.test(oib)) {
        statusDiv.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>OIB mora sadržavati točno 11 znamenki.</span>';
        return;
    }
    
    // Show loading state
    fetchBtn.disabled = true;
    fetchBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Dohvaćam...';
    statusDiv.innerHTML = '<span class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Pretražujem sudski registar...</span>';
    
    // Make API request with entity_type=supplier
    fetch(`{% url 'fetch_client_from_registry' %}?oib=${encodeURIComponent(oib)}&entity_type=supplier`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Populate form fields with the fetched data
                const formData = data.data;
                const form = document.getElementById('addSupplierForm');
                
                // Map API response to form field IDs
                const fieldMappings = {
                    'supplierName': 'id_supplierName',
                    'addressLine1': 'id_addressLine1',
                    'town': 'id_town',
                    'postalCode': 'id_postalCode',
                    'province': 'id_province',
                    'OIB': 'id_OIB',
                    'businessType': 'id_businessType'
                };
                
                // Populate each field
                for (const [apiField, formFieldId] of Object.entries(fieldMappings)) {
                    const field = form.querySelector('#' + formFieldId);
                    if (field && formData[apiField]) {
                        field.value = formData[apiField];
                        // Trigger change event for select fields
                        if (field.tagName === 'SELECT') {
                            field.dispatchEvent(new Event('change'));
                        }
                    }
                }
                
                statusDiv.innerHTML = `<span class="text-success"><i class="bi bi-check-circle me-1"></i>${data.message}</span>`;
                
            } else {
                statusDiv.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>${data.error}</span>`;
            }
        })
        .catch(error => {
            console.error('Error fetching from registry:', error);
            statusDiv.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Greška pri komunikaciji s API-jem. Pokušajte ponovo.</span>';
        })
        .finally(() => {
            // Reset button state
            fetchBtn.disabled = false;
            fetchBtn.innerHTML = '<i class="bi bi-download me-1"></i>Dohvati';
        });
}

// Allow pressing Enter in the OIB input to trigger fetch
document.getElementById('lookupOibSupplier').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        fetchSupplierFromRegistry();
    }
});

// Auto-format OIB input (only digits)
document.getElementById('lookupOibSupplier').addEventListener('input', function(e) {
    this.value = this.value.replace(/\D/g, '').slice(0, 11);
});

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.view-supplier').forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('viewSupplierTitle').textContent = this.getAttribute('data-naziv');
            document.getElementById('viewSupplierNaziv').textContent = this.getAttribute('data-naziv');
            document.getElementById('viewSupplierOIB').textContent = this.getAttribute('data-oib') || '-';
            document.getElementById('viewSupplierIBAN').textContent = this.getAttribute('data-iban') || '-';
            document.getElementById('viewSupplierAdresa').textContent = this.getAttribute('data-adresa');
            document.getElementById('viewSupplierGrad').textContent = this.getAttribute('data-grad') + ' ' + this.getAttribute('data-postanski-broj');
            document.getElementById('viewSupplierZupanija').textContent = this.getAttribute('data-zupanija');
            document.getElementById('viewSupplierPostanski').textContent = this.getAttribute('data-postanski-broj');
            document.getElementById('viewSupplierTelefon').textContent = this.getAttribute('data-telefon') || '-';
            document.getElementById('viewSupplierEmail').textContent = this.getAttribute('data-email') || '-';
            document.getElementById('viewSupplierVrsta').textContent = this.getAttribute('data-vrsta-subjekta');
            document.getElementById('viewSupplierNapomena').textContent = this.getAttribute('data-napomena') || '-';
        });
    });
    
    document.querySelectorAll('.edit-supplier').forEach(button => {
        button.addEventListener('click', function() {
            const form = document.getElementById('edit-supplier-form');
            
            document.getElementById('edit_supplier_id').value = this.getAttribute('data-id');
            document.getElementById('editSupplierTitle').textContent = this.getAttribute('data-naziv');
            
            form.querySelector('#id_supplierName').value = this.getAttribute('data-naziv');
            form.querySelector('#id_addressLine1').value = this.getAttribute('data-adresa');
            form.querySelector('#id_town').value = this.getAttribute('data-grad');
            form.querySelector('#id_postalCode').value = this.getAttribute('data-postanski-broj');
            form.querySelector('#id_province').value = this.getAttribute('data-zupanija');
            form.querySelector('#id_phoneNumber').value = this.getAttribute('data-telefon');
            form.querySelector('#id_emailAddress').value = this.getAttribute('data-email');
            form.querySelector('#id_businessType').value = this.getAttribute('data-vrsta-subjekta');
            form.querySelector('#id_OIB').value = this.getAttribute('data-oib');
            form.querySelector('#id_IBAN').value = this.getAttribute('data-iban');
            form.querySelector('#id_notes').value = this.getAttribute('data-napomena');
        });
    });
    
    document.querySelectorAll('.delete-supplier').forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('deleteSupplierName').textContent = this.getAttribute('data-naziv');
            document.getElementById('delete_supplier_id').value = this.getAttribute('data-id');
        });
    });
});
</script>
{% endblock %}
