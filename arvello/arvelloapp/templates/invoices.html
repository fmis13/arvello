{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load history_extras %}

{% block title %}Računi - {{ block.super }}{% endblock %}

{% block main %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Računi</h1>
  <div class="d-flex gap-2">
    <a href="{% get_history_url 'Invoice' %}" class="btn btn-secondary">
      <span class="material-symbols-outlined">history</span>
      Povijest promjena
    </a>
    <a href="{% url 'create_invoice' %}" class="btn btn-primary" target="_blank" rel="noopener noreferrer">
      <span class="material-symbols-outlined">add</span>
      Novi račun
    </a>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h2 class="h3 mb-0">Popis računa</h2>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" role="table" aria-label="Tablica računa">
        <thead>
          <tr>
            <th scope="col" class="col-title">Naslov</th>
            <th scope="col" class="col-client">Klijent</th>
            <th scope="col" class="col-number">Broj računa</th>
            <th scope="col" class="col-subject">Subjekt</th>
            <th scope="col" class="col-due">Dospijeće</th>
            <th scope="col" class="col-notes">Bilješke</th>
            <th scope="col" class="text-center actions-col">Akcije</th>
          </tr>
        </thead>
        <tbody>
          {% for invoice in invoices %}
          <tr class="{% if invoice.get_overdue_status == 'warning' %}row-overdue-warning{% elif invoice.get_overdue_status == 'danger' %}row-overdue-danger{% endif %}">
              <td>{% if invoice.title %}{{ invoice.title }}{% else %}<span class="empty-value" aria-hidden="true">∅</span><span class="sr-only">(prazno)</span>{% endif %}</td>
            <td>{{ invoice.client.clientName }}</td>
            <td>{{ invoice.number }}</td>
            <td>{{ invoice.subject.clientName }}</td>
            <td>{{ invoice.dueDate|date:"d.m.Y." }}</td>
            <td title="{{ invoice.notes|escape }}">{{ invoice.notes|truncatechars:50 }}</td>
            <td class="text-center actions-col">
              <div class="d-flex justify-content-center gap-1">
                <a href="{% url 'invoice_pdf' invoice.id %}" target="_blank" rel="noopener noreferrer"
                   class="btn btn-sm btn-outline-secondary action-btn" aria-label="Preuzmi PDF računa {{ invoice.number }}">
                  <span class="material-symbols-outlined action-icon">download</span>
                </a>
                <form method="post" action="{% url 'mark_invoice_paid' invoice.id %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm action-btn {% if invoice.is_paid %}btn-success{% else %}btn-outline-secondary{% endif %}"
                          aria-label="{% if invoice.is_paid %}Označi kao neplaćeno{% else %}Označi kao plaćeno{% endif %}">
                    <span class="material-symbols-outlined action-icon">check</span>
                  </button>
                </form>
                <form method="post" action="{% url 'send_invoice_email' invoice.id %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-secondary action-btn"
                          aria-label="Pošalji račun emailom">
                    <span class="material-symbols-outlined action-icon">email</span>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-secondary py-4">
              Nema računa za prikaz.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="mt-3 text-muted small">
  <a href="{% url 'admin:arvelloapp_invoice_changelist' %}" class="text-decoration-none">
    Administrator može brisati račune
  </a>
</div>
{% endblock %}
